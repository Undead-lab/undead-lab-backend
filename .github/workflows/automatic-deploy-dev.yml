name: CI

on: 
  push:
    branches: dev

jobs:
  build-and-deploy-frontend:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Build the project front
      run: |
        cd frontend
        yarn global add @vue/cli
        yarn install
        yarn build
    - name: Publish to netlify
      uses: netlify/actions/cli@master
      with:
        args: deploy --dir=frontend/dist --prod
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_DEV_SITE_ID }}
        
    
  build-and-deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Set up JDK 1.11
        uses: actions/setup-java@v1
        with:
          java-version: 1.11
      - name: Build the project back
        run: mvn package -f backend/pom.xml
      - name: Create the native image
        run: |
          cd backend
          chmod +x docker-build.sh
          ./docker-build.sh
      - name: push to heroku
        run: |
          cd backend
          docker login --username=_ --password=$(heroku auth:token) registry.heroku.com
          docker tag wootlab-io-backend registry.heroku.com/wootlab-io-dev/web
          docker push registry.heroku.com/wootlab-io-dev/web
          heroku container:release web -a wootlab-io-dev
        env:
          HEROKU_API_KEY: ${{ secrets.HEROKU_TOKEN }}
          
